<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Education Desktop App</title>
  <!-- Materialize CSS for Material Design -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <meta name="viewport" content="width=1100, initial-scale=1.0">
  <style>
    body {
      background: #f5f6fa;
    }
    .brand-logo {
      font-weight: 700;
      letter-spacing: 1px;
    }
    .side-nav-fixed {
      height: 100vh;
      background: #263238;
      color: #fff;
      padding-top: 2rem;
    }
    .side-nav-fixed .active {
      background: #37474f;
      border-radius: 8px;
    }
    .main-content {
      margin-left: 260px;
      padding: 2rem 3rem;
    }
    .input-field {
      display: flex;
      flex-direction: column;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(44,62,80,0.08);
    }
    .mcq-options label {
      display: block;
      margin-bottom: 0.5rem;
    }
    .mcq-question {
      font-weight: 600;
      font-size: 1.15rem;
      margin-bottom: 0.5rem;
    }
    .feature-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #263238;
    }
    .btn {
      border-radius: 8px;
    }
    .score-result {
      font-size: 1.2rem;
      font-weight: 600;
      color: #388e3c;
      margin-top: 1.5rem;
    }
    @media (max-width: 900px) {
      .main-content {
        margin-left: 0;
        padding: 1rem;
      }
      .side-nav-fixed {
        display: none;
      }
    }
  </style>
</head>
<body>
  <ul class="side-nav-fixed" style="width: 240px; position: fixed;">
    <li style="padding: 0 1.5rem 1.5rem 1.5rem;">
      <span class="brand-logo" style="font-size: 1.7rem;">EduSuite</span>
    </li>
    <li class="active" style="padding: 0.5rem 1.5rem;">
      <i class="material-icons left">assignment</i> MCQ Exam
    </li>
    <li style="padding: 0.5rem 1.5rem; color: #90a4ae;">
      <i class="material-icons left">more_horiz</i> More features coming soon
    </li>
  </ul>
  <div class="main-content">
    <div class="feature-title">MCQ Exam Generator</div>
    <div class="card" style="padding: 2rem;">
      <form id="examForm">
        <div class="row">
          <div class="input-field col s12 m4">
            <p style="margin-bottom: 0.7rem;"><b>Subjects</b></p>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <label>
                <input type="checkbox" class="with-gap" name="subject" value="physics" checked/>
                <span>Physics</span>
              </label>
              <label>
                <input type="checkbox" class="with-gap" name="subject" value="chemistry" checked/>
                <span>Chemistry</span>
              </label>
              <label>
                <input type="checkbox" class="with-gap" name="subject" value="biology" checked/>
                <span>Biology</span>
              </label>
            </div>
          </div>
          <div class="input-field col s12 m4">
            <b>Grade</b>
            <select id="grade" class="browser-default">
              <option value="random">Random</option>
              <option value="11">11</option>
              <option value="12">12</option>
            </select>
            <b>Difficulty</b>
            <select id="difficulty" class="browser-default">
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
<!-- Topics input removed -->
          </div>
        </div>
        <button type="submit" class="btn waves-effect waves-light blue darken-2" style="margin-top: 1rem;">Generate Exam</button>
      </form>
      <div id="mcqSection" style="display:none; margin-top:2rem;">
        <h5>MCQs</h5>
        <form id="mcqForm"></form>
        <button id="submitAnswers" class="btn green darken-2" style="display:none; margin-top:1rem;">Submit Answers</button>
        <div id="scoreResult" class="score-result"></div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const backendUrl = "http://127.0.0.1:8000";
    let examId = null;
    let mcqs = [];

    // Topic input and suggestion logic removed

    document.getElementById('examForm').onsubmit = async function(e) {
      e.preventDefault();
      const selectedSubjects = Array.from(document.querySelectorAll('input[name="subject"]:checked')).map(cb => cb.value);
      if (selectedSubjects.length === 0) {
        M.toast({html: "Select at least one subject.", classes: "red"});
        return;
      }
      const grade = document.getElementById('grade').value;
      const difficulty = document.getElementById('difficulty').value;
      // Always use "localuser" for single-user offline mode
      const user_id = "localuser";
      const subjects = selectedSubjects.map(subj => ({
        subject: subj,
        grade: grade,
        difficulty: difficulty
      }));
      // Call /generate_exam
      const res = await fetch(backendUrl + "/generate_exam", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subjects: subjects,
          language: "en",
          user_id: user_id
        })
      });
      if (!res.ok) {
        const errorText = await res.text();
        M.toast({html: "Failed to generate exam: " + errorText, classes: "red"});
        console.error("Generate Exam Error:", errorText);
        return;
      }
      const data = await res.json();
      examId = data.exam_id;
      // Call /generate_mcqs with questions array
      const mcqRes = await fetch(backendUrl + "/generate_mcqs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ questions: data.questions })
      });
      if (!mcqRes.ok) {
        const mcqErrorText = await mcqRes.text();
        M.toast({html: "Failed to generate MCQs: " + mcqErrorText, classes: "red"});
        console.error("Generate MCQs Error:", mcqErrorText);
        return;
      }
      const mcqData = await mcqRes.json();
      mcqs = mcqData.mcqs;
      showMcqs();
    };

    function showMcqs() {
      const mcqSection = document.getElementById('mcqSection');
      const mcqForm = document.getElementById('mcqForm');
      mcqForm.innerHTML = "";
      mcqs.forEach((mcq, idx) => {
        const block = document.createElement('div');
        block.className = "question-block";
        block.innerHTML = `<div class="mcq-question">Q${idx+1}: ${mcq.question}</div><div class="mcq-options"></div>`;
        const optionsDiv = block.querySelector('.mcq-options');
        mcq.options.forEach((opt, optIdx) => {
          const optId = `q${idx}_opt${optIdx}`;
          optionsDiv.innerHTML += `
            <label>
              <input type="radio" name="q${idx}" value="${optIdx}" required/>
              <span>${String.fromCharCode(65+optIdx)}. ${opt}</span>
            </label>
          `;
        });
        mcqForm.appendChild(block);
      });
      mcqSection.style.display = "";
      document.getElementById('submitAnswers').style.display = "";
      document.getElementById('scoreResult').innerText = "";
    }

    document.getElementById('submitAnswers').onclick = async function(e) {
      e.preventDefault();
      const answers = {};
      let allAnswered = true;
      mcqs.forEach((mcq, idx) => {
        const selected = document.querySelector(`input[name="q${idx}"]:checked`);
        if (selected) {
          answers[idx] = parseInt(selected.value, 10);
        } else {
          allAnswered = false;
        }
      });
      if (!allAnswered) {
        M.toast({html: "Please answer all questions.", classes: "red"});
        return;
      }
      // Calculate score
      let correct = 0;
      mcqs.forEach((mcq, idx) => {
        if (answers[idx] === mcq.answer_index) correct++;
      });
      const score = `${correct} / ${mcqs.length}`;
      document.getElementById('scoreResult').innerText = "Your Score: " + score;
    };
  </script>
</body>
</html>
