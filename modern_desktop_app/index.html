<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Education Desktop App</title>
  <!-- Materialize CSS for Material Design -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <meta name="viewport" content="width=1100, initial-scale=1.0">
  <style>
    body {
      background: #f5f6fa;
    }
    .brand-logo {
      font-weight: 700;
      letter-spacing: 1px;
    }
    .side-nav-fixed {
      height: 100vh;
      background: #263238;
      color: #fff;
      padding-top: 2rem;
    }
    .side-nav-fixed .active {
      background: #37474f;
      border-radius: 8px;
    }
    .main-content {
      margin-left: 260px;
      padding: 2rem 3rem;
    }
    .input-field {
      display: flex;
      flex-direction: column;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(44,62,80,0.08);
    }
    .mcq-options label {
      display: block;
      margin-bottom: 0.5rem;
    }
    .mcq-question {
      font-weight: 600;
      font-size: 1.15rem;
      margin-bottom: 0.5rem;
    }
    .feature-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #263238;
    }
    .btn {
      border-radius: 8px;
    }
    .score-result {
      font-size: 1.2rem;
      font-weight: 600;
      color: #388e3c;
      margin-top: 1.5rem;
    }
    @media (max-width: 900px) {
      .main-content {
        margin-left: 0;
        padding: 1rem;
      }
      .side-nav-fixed {
        display: none;
      }
    }
  </style>
</head>
<body>
  <ul class="side-nav-fixed" style="width: 240px; position: fixed;">
    <li style="padding: 0 1.5rem 1.5rem 1.5rem;">
      <span class="brand-logo" style="font-size: 1.7rem;">EduSuite</span>
    </li>
    <li class="active" id="tab-mcq" style="padding: 0.5rem 1.5rem; cursor:pointer;">
      <i class="material-icons left">assignment</i> MCQ Exam
    </li>
    <li id="tab-history" style="padding: 0.5rem 1.5rem; cursor:pointer;">
      <i class="material-icons left">history</i> Previous Tests
    </li>
    <li style="padding: 0.5rem 1.5rem; color: #90a4ae;">
      <i class="material-icons left">more_horiz</i> More features coming soon
    </li>
  </ul>
  <div class="main-content">
    <div id="mcq-section">
      <div class="feature-title">MCQ Exam Generator</div>
      <div class="card" style="padding: 2rem;">
      <form id="examForm">
        <div class="row">
          <div class="input-field col s12 m4">
            <p style="margin-bottom: 0.7rem;"><b>Subjects</b></p>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <label>
                <input type="checkbox" class="with-gap" name="subject" value="physics" checked/>
                <span>Physics</span>
              </label>
              <label>
                <input type="checkbox" class="with-gap" name="subject" value="chemistry" checked/>
                <span>Chemistry</span>
              </label>
              <label>
                <input type="checkbox" class="with-gap" name="subject" value="biology" checked/>
                <span>Biology</span>
              </label>
            </div>
          </div>
          <div class="input-field col s12 m4">
            <b>Grade</b>
            <select id="grade" class="browser-default">
              <option value="random">Random</option>
              <option value="11">11</option>
              <option value="12">12</option>
            </select>
            <b>Difficulty</b>
            <select id="difficulty" class="browser-default">
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
<!-- Topics input removed -->
          </div>
        </div>
        <button type="submit" class="btn waves-effect waves-light blue darken-2" style="margin-top: 1rem;">Generate Exam</button>
      </form>
      <div id="mcqSection" style="display:none; margin-top:2rem;">
        <h5>MCQs</h5>
        <form id="mcqForm"></form>
        <button id="submitAnswers" class="btn green darken-2" style="display:none; margin-top:1rem;">Submit Answers</button>
        <div id="scoreResult" class="score-result"></div>
      </div>
    </div>
    <div id="history-section" style="display:none;">
      <div class="feature-title">Previous Tests</div>
      <div class="card" style="padding: 2rem;">
        <div id="previous-tests-list"></div>
        <div id="test-details" style="margin-top:1em;">
          <canvas id="performance-graph" width="400" height="200" style="display:none;"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- Chart.js CDN for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const backendUrl = "http://127.0.0.1:8000";
    let examId = null;
    let mcqs = [];

    // Topic input and suggestion logic removed

    document.getElementById('examForm').onsubmit = async function(e) {
      e.preventDefault();
      const selectedSubjects = Array.from(document.querySelectorAll('input[name="subject"]:checked')).map(cb => cb.value);
      if (selectedSubjects.length === 0) {
        M.toast({html: "Select at least one subject.", classes: "red"});
        return;
      }
      const grade = document.getElementById('grade').value;
      const difficulty = document.getElementById('difficulty').value;
      // Always use "localuser" for single-user offline mode
      const user_id = "localuser";
      const subjects = selectedSubjects.map(subj => ({
        subject: subj,
        grade: grade,
        difficulty: difficulty
      }));
      // Call /generate_exam
      const res = await fetch(backendUrl + "/generate_exam", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subjects: subjects,
          language: "en",
          user_id: user_id
        })
      });
      if (!res.ok) {
        const errorText = await res.text();
        M.toast({html: "Failed to generate exam: " + errorText, classes: "red"});
        console.error("Generate Exam Error:", errorText);
        return;
      }
      const data = await res.json();
      examId = data.exam_id;
      // Call /generate_mcqs with questions array
      const mcqRes = await fetch(backendUrl + "/generate_mcqs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ questions: data.questions })
      });
      if (!mcqRes.ok) {
        const mcqErrorText = await mcqRes.text();
        M.toast({html: "Failed to generate MCQs: " + mcqErrorText, classes: "red"});
        console.error("Generate MCQs Error:", mcqErrorText);
        return;
      }
      const mcqData = await mcqRes.json();
      mcqs = mcqData.mcqs;
      showMcqs();
    };

    function showMcqs() {
      const mcqSection = document.getElementById('mcqSection');
      const mcqForm = document.getElementById('mcqForm');
      mcqForm.innerHTML = "";
      mcqs.forEach((mcq, idx) => {
        // Use backend question ID if available, else fallback to idx
        // Also, store the qid on the block for debugging
        const qid = String(
          mcq.id ||
          mcq.question_id ||
          mcq.QID ||
          mcq.qid ||
          mcq.index ||
          mcq.Qid ||
          idx
        );
        const block = document.createElement('div');
        block.className = "question-block";
        block.setAttribute("data-qid", qid);
        block.innerHTML = `<div class="mcq-question">Q${idx+1}: ${mcq.question}</div><div class="mcq-options"></div>`;
        const optionsDiv = block.querySelector('.mcq-options');
        mcq.options.forEach((opt, optIdx) => {
          const optId = `q${qid}_opt${optIdx}`;
          optionsDiv.innerHTML += `
            <label>
              <input type="radio" name="q${qid}" value="${opt}" required/>
              <span>${String.fromCharCode(65+optIdx)}. ${opt}</span>
            </label>
          `;
        });
        mcqForm.appendChild(block);
      });
      mcqSection.style.display = "";
      document.getElementById('submitAnswers').style.display = "";
      document.getElementById('scoreResult').innerText = "";
    }

    document.getElementById('submitAnswers').onclick = async function(e) {
      e.preventDefault();
      const answers = {};
      let allAnswered = true;
      mcqs.forEach((mcq, idx) => {
        // Use the same qid logic as in showMcqs
        const qid = String(
          mcq.id ||
          mcq.question_id ||
          mcq.QID ||
          mcq.qid ||
          mcq.index ||
          mcq.Qid ||
          idx
        );
        const selected = document.querySelector(`input[name="q${qid}"]:checked`);
        if (selected) {
          answers[qid] = selected.value;
        } else {
          allAnswered = false;
        }
      });
      if (!allAnswered) {
        M.toast({html: "Please answer all questions.", classes: "red"});
        return;
      }
      // Calculate score (frontend, for instant feedback)
      let correct = 0;
      mcqs.forEach((mcq, idx) => {
        const qid = String(
          mcq.id ||
          mcq.question_id ||
          mcq.QID ||
          mcq.qid ||
          mcq.index ||
          mcq.Qid ||
          idx
        );
        const userAns = answers[qid];
        const correctAns = mcq.options[mcq.answer_index];
        if (userAns && userAns.trim().toLowerCase() === correctAns.trim().toLowerCase()) correct++;
      });
      const score = `${correct} / ${mcqs.length}`;
      document.getElementById('scoreResult').innerText = "Your Score: " + score;

      // --- Submit answers to backend for saving ---
      if (!examId) {
        M.toast({html: "Exam ID missing. Please regenerate the exam.", classes: "red"});
        return;
      }
      try {
        const res = await fetch(backendUrl + "/submit_answers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: "localuser",
            exam_id: examId,
            answers: answers,
            questions: mcqs // send MCQ-enriched questions for backend scoring/review
          })
        });
        if (!res.ok) {
          const errorText = await res.text();
          M.toast({html: "Failed to save your test: " + errorText, classes: "red"});
        }
      } catch (err) {
        M.toast({html: "Error saving your test.", classes: "red"});
      }
    };
    // --- Tab switching logic ---
    const tabMcq = document.getElementById("tab-mcq");
    const tabHistory = document.getElementById("tab-history");
    const mcqSection = document.getElementById("mcq-section");
    const historySection = document.getElementById("history-section");

    function setActiveTab(tab) {
      document.querySelectorAll(".side-nav-fixed li").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
    }

    tabMcq.addEventListener("click", () => {
      setActiveTab(tabMcq);
      mcqSection.style.display = "";
      historySection.style.display = "none";
    });

    tabHistory.addEventListener("click", () => {
      setActiveTab(tabHistory);
      mcqSection.style.display = "none";
      historySection.style.display = "";
      fetchPreviousTests();
    });

    // --- Previous Tests logic ---
    async function fetchPreviousTests() {
      const listDiv = document.getElementById("previous-tests-list");
      listDiv.innerHTML = "Loading...";
      try {
        const res = await fetch(`${backendUrl}/user_submissions/localuser`);
        if (!res.ok) {
          listDiv.innerHTML = "Failed to load previous tests.";
          return;
        }
        const submissions = await res.json();
        if (submissions.length === 0) {
          listDiv.innerHTML = "No previous tests found.";
          return;
        }
        // Render list
        listDiv.innerHTML = "";
        const ul = document.createElement("ul");
        submissions.forEach((sub, idx) => {
          const li = document.createElement("li");
          li.style.cursor = "pointer";
          li.textContent = `Test ${idx + 1}: ${sub.submitted_at} | Score: ${sub.correct}/${sub.total} | Subjects: ${getSubjectsString(sub.filters)}`;
          li.onclick = () => fetchTestDetails(sub.filename);
          ul.appendChild(li);
        });
        listDiv.appendChild(ul);
      } catch (err) {
        listDiv.innerHTML = "Error loading previous tests.";
      }
    }

    function getSubjectsString(filters) {
      if (!filters) return "";
      if (Array.isArray(filters)) {
        return filters.map(f => `${f.subject} (G${f.grade}, ${f.difficulty})`).join(", ");
      }
      // fallback for old format
      return Object.values(filters).join(", ");
    }

    async function fetchTestDetails(filename) {
      const detailsDiv = document.getElementById("test-details");
      detailsDiv.innerHTML = "Loading test details...";
      try {
        const res = await fetch(`${backendUrl}/submission/${filename}`);
        if (!res.ok) {
          detailsDiv.innerHTML = "Failed to load test details.";
          return;
        }
        const data = await res.json();
        renderTestDetails(data, detailsDiv);
      } catch (err) {
        detailsDiv.innerHTML = "Error loading test details.";
      }
    }

    function renderTestDetails(data, container) {
      let html = `<h5>Test Details</h5>`;
      html += `<b>Date:</b> ${data.submitted_at || ""}<br>`;
      html += `<b>Score:</b> ${data.correct} / ${data.total} (${((data.score || 0) * 100).toFixed(1)}%)<br>`;
      html += `<b>Subjects:</b> ${getSubjectsString(data.filters)}<br>`;
      html += `<hr>`;
      html += `<b>Questions & Answers:</b><br>`;
      if (Array.isArray(data.questions_with_answers)) {
        html += "<ol>";
        data.questions_with_answers.forEach((qwa, idx) => {
          html += `<li><b>${qwa.question || "Question"}</b><br>`;
          html += `Your answer: <span style="color:${qwa.user_answer && qwa.user_answer.trim().toLowerCase() === qwa.correct_answer.trim().toLowerCase() ? 'green' : 'red'}">${qwa.user_answer || "(no answer)"}</span><br>`;
          html += `Correct answer: <b>${qwa.correct_answer || ""}</b><br>`;
          html += `<i>Subject: ${qwa.subject || ""}, Topic: ${qwa.topic || ""}, Difficulty: ${qwa.difficulty || ""}</i>`;
          html += `</li>`;
        });
        html += "</ol>";
      }
      container.innerHTML = html;

      // --- Performance Graphs ---
      const perfGraph = document.getElementById("performance-graph");
      if (!perfGraph) return;
      // Compute subject-wise and topic-wise performance
      // (Optional: you can use qwa.subject, qwa.user_answer, qwa.correct_answer for analytics)
      // For now, hide the graph if not needed
      perfGraph.style.display = "none";
    }

    function computePerformance(questions, answers) {
      // Returns { subjects: {labels, correct, incorrect}, topics: {labels, correct, incorrect} }
      const subjStats = {};
      const topicStats = {};
      questions.forEach((q, idx) => {
        const qid = String(q.id || q.question_id || q.QID || q.qid || q.index || idx);
        const userAns = answers && answers[qid] !== undefined ? answers[qid] : null;
        const correctAns = q.answer || q.Answer || q.correct_answer || "";
        const isCorrect = userAns !== null && String(userAns).trim().toLowerCase() === String(correctAns).trim().toLowerCase();
        // Subject
        const subj = q.subject || "Unknown";
        if (!subjStats[subj]) subjStats[subj] = { correct: 0, incorrect: 0 };
        if (isCorrect) subjStats[subj].correct += 1;
        else subjStats[subj].incorrect += 1;
        // Topic
        const topic = q.topic || "Unknown";
        if (!topicStats[topic]) topicStats[topic] = { correct: 0, incorrect: 0 };
        if (isCorrect) topicStats[topic].correct += 1;
        else topicStats[topic].incorrect += 1;
      });
      return {
        subjects: {
          labels: Object.keys(subjStats),
          correct: Object.values(subjStats).map(s => s.correct),
          incorrect: Object.values(subjStats).map(s => s.incorrect)
        },
        topics: {
          labels: Object.keys(topicStats),
          correct: Object.values(topicStats).map(s => s.correct),
          incorrect: Object.values(topicStats).map(s => s.incorrect)
        }
      };
    }

    let chartInstance = null;
    function renderBarChart(canvas, labels, correctData, incorrectData, title) {
      if (chartInstance) {
        chartInstance.destroy();
      }
      chartInstance = new Chart(canvas, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Correct",
              data: correctData,
              backgroundColor: "rgba(75, 192, 192, 0.7)"
            },
            {
              label: "Incorrect",
              data: incorrectData,
              backgroundColor: "rgba(255, 99, 132, 0.7)"
            }
          ]
        },
        options: {
          responsive: false,
          plugins: {
            title: {
              display: true,
              text: title
            }
          },
          scales: {
            x: { stacked: true },
            y: { beginAtZero: true, stacked: true }
          }
        }
      });
    }
  </script>
</body>
</html>
